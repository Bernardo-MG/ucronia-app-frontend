<p-menu #personEditionMenu [model]="personEditionMenuItems" [popup]="true" />
<header>
  <h1 class="border-bottom">Gente</h1>
</header>
<div class="row pb-2">
  <!-- Membership evolution -->
  <div uiJustifyCenter>
    <widget-membership-evolution-chart />
  </div>
</div>
<div class="row">
  <!-- Member List -->
  <p-panel>
    <ng-template #icons>
      <!-- Add transaction -->
      <p-button icon="pi pi-plus-circle" severity="secondary" (click)="onStartEditingView('creation')"
        [disabled]="!createable" aria-label="Nueva persona" [attr.aria-disabled]="!createable" rounded text />
      <!-- Filter by membership -->
      <assoc-person-status-select [disabled]="loading" (changeStatus)="onChangeActiveFilter($event)" />
      <!-- Filter by name -->
      <label for="nameFilterInput" id="nameFilterLabel" class="col-sm-2 col-form-label">Nombre</label>
      <input type="text" id="nameFilterInput" [(ngModel)]="nameFilter" (input)="nameFilterSubject.next(nameFilter)"
        aria-describedby="nameFilterLabel" maxlength="50">
    </ng-template>
    <p-table lazy="true" dataKey="number" [loading]="loading" [value]="data.content" paginator="true" [rows]="data.size"
      [totalRecords]="data.totalElements" [first]="first" showCurrentPageReport="true"
      currentPageReportTemplate="Total: {totalRecords}" (onSort)="onChangeDirection($event)"
      (onPage)="onPageChange($event)">
      <ng-template #header>
        <tr>
          <th pSortableColumn="fullName">Nombre <p-sortIcon field="fullName" /></th>
          <th pSortableColumn="active">Activo <p-sortIcon field="active" /></th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-person>
        <tr>
          <td>{{ person.name.fullName }}</td>
          <td>
            @switch (person.membership === null) {
            @case (true) {
            No es socio
            }
            @case (false) {
            @switch (person.membership?.active) {
            @case (true) {
            <span class="pi pi-check text-success"></span>
            }
            @case (false) {
            <span class="pi pi-times text-warning"></span>
            }
            }
            }
            }
          </td>
          <td>
            <p-button icon="pi pi-eye" severity="secondary" aria-label="Ver" (click)="onShowInfo(person)" rounded
              text />
            <p-button icon="pi pi-pencil" severity="secondary" [disabled]="!editable" aria-label="Editar"
              [attr.aria-disabled]="!editable" (click)="openEditionMenu($event, person)" rounded text />
            <p-button icon="pi pi-trash" severity="danger" [disabled]="!editable" aria-label="Borrar"
              [attr.aria-disabled]="!editable" (click)="onConfirmDelete($event, person.number)" rounded text />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-panel>
</div>
@if(showing) {
  <p-dialog header="Persona" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <assoc-people-info [data]="selectedData" />
  </p-dialog>
}
@switch (view) {
  @case ('creation') {
    <p-dialog header="Crear persona" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
      <assoc-people-creation-form [waiting]="saving" [failures]="failures" (save)="onCreate($event)" />
    </p-dialog>
  }
  @case ('edition') {
    <p-dialog header="Editar persona" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
      <assoc-people-edition-form [waiting]="saving" [data]="selectedData" [failures]="failures" [cancellable]="true"
        (save)="onUpdate($event)" />
    </p-dialog>
  }
}