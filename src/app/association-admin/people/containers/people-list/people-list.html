<p-confirmpopup />
<header>
  <h1 class="border-bottom">Gente</h1>
</header>
<div class="row pb-2">
  <!-- Membership evolution -->
  <div uiJustifyCenter>
    <widget-membership-evolution-chart />
  </div>
</div>
<div class="row">
  <!-- Member List -->
  <p-panel>
    <ng-template #icons>
      <!-- Add transaction -->
      <p-button icon="pi pi-plus-circle" severity="secondary" (click)="onStartEditingView('creation')"
        [disabled]="!createable" aria-label="Nueva persona" [attr.aria-disabled]="!createable" rounded text />
    </ng-template>
    <ng-template #header>
      <div class="row">
        <div class="col-sm-3">
          <!-- Add person -->
          <button type="button" class="btn btn-link" aria-label="register" routerLink="register"
            [disabled]="!createable" [attr.aria-disabled]="!createable">
            <icon-add />
          </button>
        </div>
        <div class="offset-md-7 col-sm-2">
          <!-- Filter by membership -->
          <assoc-person-status-select [disabled]="loading" (changeStatus)="onChangeActiveFilter($event)" />
        </div>
      </div>
      <div class="row">
        <!-- Filter by name -->
        <div class="col-sm-5">
          <label for="nameFilterInput" id="nameFilterLabel" class="col-sm-2 col-form-label">Nombre</label>
          <input type="text" id="nameFilterInput" [(ngModel)]="nameFilter" (input)="nameFilterSubject.next(nameFilter)"
            aria-describedby="nameFilterLabel" maxlength="50">
        </div>
      </div>
    </ng-template>
    <p-table lazy="true" dataKey="number" selectionMode="single" [loading]="loading" [value]="data.content"
      [(selection)]="selectedData" paginator="true" [rows]="data.size" [totalRecords]="data.totalElements"
      [first]="first" showCurrentPageReport="true" currentPageReportTemplate="Total: {totalRecords}"
      (onSort)="onChangeDirection($event)" (onPage)="onPageChange($event)" (onRowSelect)="onSelectRow()">
      <ng-template #header>
        <tr>
          <th pSortableColumn="fullName">Nombre <p-sortIcon field="fullName" /></th>
          <th pSortableColumn="active">Activo <p-sortIcon field="active" /></th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-person>
        <tr [pSelectableRow]="person">
          <td>{{ person.name.fullName }}</td>
          <td>
            @switch (person.membership === null) {
            @case (true) {
            No es socio
            }
            @case (false) {
            @switch (person.membership?.active) {
            @case (true) {
            <span class="pi pi-check text-success"></span>
            }
            @case (false) {
            <span class="pi pi-times text-warning"></span>
            }
            }
            }
            }
          </td>
          <td>
            <p-button icon="pi pi-eye" severity="secondary" aria-label="Ver" [attr.aria-disabled]="!editable"
              (click)="onShowInfo(person)" rounded text />
            <p-button icon="pi pi-pencil" severity="secondary" [disabled]="!editable" aria-label="Editar"
              [attr.aria-disabled]="!editable" (click)="onStartEditingView('edition')" rounded text />
            <p-button icon="pi pi-trash" severity="danger" [disabled]="!editable" aria-label="Borrar"
              [attr.aria-disabled]="!editable" (click)="onConfirmDelete($event, person.number)" rounded text />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-panel>
</div>
<p-drawer [(visible)]="showing" position="full">
</p-drawer>
<p-drawer [(visible)]="editing" position="right">
  @switch (view) {
  @case ('creation') {
  <assoc-people-creation-form [waiting]="saving" [failures]="failures" (save)="onCreate($event)" />
  }
  @case ('edition') {
  <assoc-people-edition-form [waiting]="saving" [data]="selectedData" [failures]="failures"
    [cancellable]="true" (save)="onUpdate($event)" />
  }
  }
</p-drawer>