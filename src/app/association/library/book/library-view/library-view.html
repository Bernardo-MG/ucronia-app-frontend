<p-menu #dataMenu [model]="dataMenuItems" [popup]="true" />

<div class="p-4 space-y-6">
  <h1 class="text-4xl font-bold">Library</h1>
  <p class="text-gray-600">Manage game books and fiction</p>


  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
    <div class="p-6 rounded-2xl shadow bg-white flex items-center space-x-4">
      <i class="pi pi-book text-3xl"></i>
      <div>
        <p class="text-2xl font-semibold">1</p>
        <p class="uppercase text-gray-500 text-sm">Juegos</p>
      </div>
    </div>


    <div class="p-6 rounded-2xl shadow bg-white flex items-center space-x-4">
      <i class="pi pi-book text-3xl"></i>
      <div>
        <p class="text-2xl font-semibold">0</p>
        <p class="uppercase text-gray-500 text-sm">Ficción</p>
      </div>
    </div>


    <div class="p-6 rounded-2xl shadow bg-white flex items-center space-x-4">
      <i class="pi pi-bookmark text-3xl"></i>
      <div>
        <p class="text-2xl font-semibold">0</p>
        <p class="uppercase text-gray-500 text-sm">Prestados</p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex flex-wrap mb-3 items-center w-full space-x-2">
    <div class="border border-gray-300 rounded-lg p-1 inline-block">
      <p-selectbutton [options]="stateOptions" [(ngModel)]="selectedTab" optionLabel="label" optionValue="value"
        aria-labelledby="basic" />
    </div>

    @if (createable) {
    <p-button icon="pi pi-plus-circle" (click)="onStartEditingView('creation')" [disabled]="!createable"
      aria-label="Nuevo libro" [attr.aria-disabled]="!createable" rounded class="ml-auto" />
    }

    <p-button icon="pi pi-file-excel" [disabled]="loadingExcel" (click)="downloadExcel()" aria-label="Descargar excel"
      [attr.aria-disabled]="loadingExcel" rounded />

    @if (dataMenuItems) {
    <p-button icon="pi pi-cog" rounded (click)="dataMenu.toggle($event)" aria-label="Editar datos" />
    }
  </div>

  <p-card header="Préstamos" class="mb-2">
    <a routerLink="/association/library/lendings" class="text-blue-600 underline">
      Ver préstamos
    </a>
  </p-card>

  <p-panel>

    <!-- Tailwind select -->
    <select [disabled]="loading" class="mt-2 mb-4 w-40 rounded border border-gray-300 text-sm p-1"
      aria-label="Filter contact status" (change)="onChangeSource($event)">
      <option [selected]="source === 'game'" value="game">Juegos</option>
      <option [selected]="source === 'fiction'" value="fiction">Ficción</option>
    </select>

    <assoc-library-book-list [editable]="editable" [deletable]="deletable" [loading]="loading" [books]="data.content"
    [rows]="data.size" [page]="data.page" [totalRecords]="data.totalElements"
    (pageChange)="load($event)" (sort)="onChangeDirection2($event)" (showBook)="onShowBook($event)" (delete)="onDelete2($event)"
    (show)="onStartEditingView($event)" />

  </p-panel>

  <!-- Dialogs -->
  <p-dialog header="Libro" [modal]="true" [(visible)]="showing" [style]="{ width: '50rem' }">
    <assoc-library-book-info [book]="selectedData" />
  </p-dialog>

  @switch (view) {

  @case ('details') {
  <p-dialog header="Editar libro" [modal]="true" [(visible)]="editing" [style]="{ width: '50rem' }">
    <ng-template #header>
      <h2 class="text-xl font-semibold">
        #{{ selectedData.number }}
        @if (selectedData.title.supertitle) { <sup>{{selectedData.title.supertitle}}</sup> }
        {{selectedData.title.title}}
        @if (selectedData.title.subtitle) { <sub>{{selectedData.title.subtitle}}</sub> }
      </h2>
    </ng-template>

    <assoc-library-book-edition-form [data]="selectedData" [loading]="loading" [failures]="failures"
      (save)="onSaveBook($event)" />
  </p-dialog>
  }

  @case ('creation') {
  <p-dialog header="Crear libro" [modal]="true" [(visible)]="editing" [style]="{ width: '50rem' }">
    <assoc-library-book-creation-form [loading]="loading" [failures]="failures" (save)="onCreate($event)" />
  </p-dialog>
  }

  @case ('donors') {
  <p-dialog header="Donantes" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <assoc-library-book-donors-form [data]="selectedData.donation" [loading]="loading" [failures]="failures"
      [getSelection]="service.getDonors.bind(service)" (save)="onSetDonation($event)" />
  </p-dialog>
  }

  @case ('authors') {
  <p-dialog header="Autores" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <shared-selection-list-form [data]="selectedData.authors" [getSelection]="service.getAuthors.bind(service)"
      (save)="onSetAuthors($event)" />
  </p-dialog>
  }

  @case ('gameSystem') {
  <p-dialog header="Sistemas" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <shared-form-with-selection [data]="getGameSystem(selectedData)"
      [getSelection]="service.getGameSystems.bind(service)" (save)="onSetGameSystem($event)" />
  </p-dialog>
  }

  @case ('bookType') {
  <p-dialog header="Tipo" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <shared-form-with-selection [data]="getBookType(selectedData)" [getSelection]="service.getBookTypes.bind(service)"
      (save)="onSetBookType($event)" />
  </p-dialog>
  }

  @case ('publishers') {
  <p-dialog header="Editores" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <shared-selection-list-form [data]="selectedData.publishers" [getSelection]="service.getPublishers.bind(service)"
      (save)="onSetPublishers($event)" />
  </p-dialog>
  }

  @case ('lendings') {
  @if(selectedData.lent) {
  <p-dialog header="Devolver libro" [modal]="true" [(visible)]="editing" [style]="{ width: '25rem' }">
    <assoc-library-book-return-form [loading]="loading" [failures]="failures" [borrower]="borrower"
      [book]="selectedData" (save)="onReturn($event)" />
  </p-dialog>
  } @else {
  <p-dialog header="Prestar libro" [modal]="true" [(visible)]="editing" [style]="{ width: '50rem' }">
    <assoc-library-book-lending [waiting]="loading" [failures]="failures" [book]="selectedData"
      [getMemberSelection]="service.getMembers.bind(service)" (save)="onLend($event)" />
  </p-dialog>
  }
  }

  }

</div>